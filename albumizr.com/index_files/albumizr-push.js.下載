$(function(){
    var self = this;
    
    this.gotoAlbumizr = function() {
        var ref = "?ref=";
        try {
            ref += encodeURIComponent(parent.location.href);
        } catch (e) {  }
        top.location.href = "http://albumizr.com/" + ref;
    }
    
    this.showCurrent = function() {
        if (instance) {
            if (instance.getCurrentUrl()) {
                top.location.href = instance.getCurrentUrl();
            }
        }
    }
    
    this.reportAbuse = function() {
        var s = location.href;
        var ix = s.indexOf("?key=");
        var ix2 = s.indexOf("&");
        if (ix2 < 0) {
            s = s.substring(ix + 5);
        }
        else {
            s = s.substring(ix + 5, ix2);
        }

        $.getJSON('/op.php', {
            'cmd' : 'report',
            'key' : s
        },function(data){
            alert("Thanks for the report!\n\nWe will investigate this content soon and remove it if needed.");
        });
    }
    
    this.goFullscreen = function() {
        var element = document.documentElement;
        if (element.requestFullscreen) {
            element.requestFullscreen();
        } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
        } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
        }
    }
    
    this.temporaryHide = function() {
        $('#albumizrTag').remove();
    }

    this.openMenu = function() {

        if ($('#albumizrTag ul').length > 0) {
            $('#albumizrTag ul').remove();
            return;
        }
        var m = $('<ul class="menu">');
        m.append($('<li>Go fullscreen</li>').click(self.goFullscreen));
        m.append($('<li>Direct image link</li>').click(self.showCurrent));
        m.append($('<li>Get rid of this icon!</li>').click(self.temporaryHide));
        m.append($('<li>Create your free album</li>').click(self.gotoAlbumizr));
        m.append($('<li>Report abuse</li>').click(self.reportAbuse));
        m.append($('<li>&#x2764; albumizr.com ...</li>').click(self.gotoAlbumizr));
        $('#albumizrTag').append(m);
        $('#albumizrTag li').click(function() {
            $('#albumizrTag ul').remove();
            var op = $(this).index();
        });
        $('#albumizrTag li').mouseover(function() {
            $('#albumizrTag li').removeClass('hover');
            $(this).addClass("hover");
        });
    }

    $('body').append($('<div>', {
        'id' : 'albumizrTag'
    }).append($('<div class="inner"></div>').click(self.openMenu)));
});
